{% extends "base.html" %}

{% block title %}ä»ªè¡¨æ¿ - MedLitAgent{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">ğŸ“Š ç³»ç»Ÿä»ªè¡¨æ¿</h1>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">æ€»è®ºæ–‡æ•°</h4>
                            <h2 id="total-papers">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-file-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">å…³é”®è¯æ•°</h4>
                            <h2 id="total-keywords">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-tags fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">åˆ†ç±»æ•°</h4>
                            <h2 id="total-categories">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-sitemap fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4 class="card-title">æ•°æ®æº</h4>
                            <h2 id="total-sources">-</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-database fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">ğŸ“ˆ è®ºæ–‡åˆ†ç±»åˆ†å¸ƒ</h5>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">ğŸ“Š æ•°æ®æºåˆ†å¸ƒ</h5>
                </div>
                <div class="card-body">
                    <canvas id="sourceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- æœ€è¿‘æ´»åŠ¨ -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">ğŸ“‹ æœ€æ–°è®ºæ–‡</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped" id="recent-papers">
                            <thead>
                                <tr>
                                    <th>æ ‡é¢˜</th>
                                    <th>ä½œè€…</th>
                                    <th>åˆ†ç±»</th>
                                    <th>æ—¥æœŸ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="4" class="text-center">åŠ è½½ä¸­...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">ğŸ”¥ çƒ­é—¨å…³é”®è¯</h5>
                </div>
                <div class="card-body">
                    <div id="popular-keywords">
                        <p class="text-center">åŠ è½½ä¸­...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // åŠ è½½ç»Ÿè®¡æ•°æ®
    loadStatistics();
    
    // åŠ è½½æœ€æ–°è®ºæ–‡
    loadRecentPapers();
    
    // åŠ è½½çƒ­é—¨å…³é”®è¯
    loadPopularKeywords();
});

function loadStatistics() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.data.database;
                document.getElementById('total-papers').textContent = stats.total_papers || 0;
                document.getElementById('total-keywords').textContent = stats.total_keywords || 0;
                document.getElementById('total-categories').textContent = stats.total_categories || 0;
                document.getElementById('total-sources').textContent = stats.total_sources || 0;
                
                // åˆ›å»ºå›¾è¡¨
                createCategoryChart(stats.category_distribution || {});
                createSourceChart(stats.source_distribution || {});
            }
        })
        .catch(error => {
            console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        });
}

function loadRecentPapers() {
    fetch('/api/papers?limit=10&sort=date_desc')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tbody = document.querySelector('#recent-papers tbody');
                tbody.innerHTML = '';
                
                if (data.data.papers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— æ•°æ®</td></tr>';
                    return;
                }
                
                data.data.papers.forEach(paper => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><a href="#" onclick="showPaperDetail(${paper.id})">${paper.title.substring(0, 50)}...</a></td>
                        <td>${paper.authors ? paper.authors.split(';').slice(0, 2).join(', ') : 'N/A'}</td>
                        <td><span class="badge badge-primary">${paper.predicted_category || 'N/A'}</span></td>
                        <td>${paper.publication_date || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
        })
        .catch(error => {
            console.error('åŠ è½½æœ€æ–°è®ºæ–‡å¤±è´¥:', error);
            document.querySelector('#recent-papers tbody').innerHTML = 
                '<tr><td colspan="4" class="text-center text-danger">åŠ è½½å¤±è´¥</td></tr>';
        });
}

function loadPopularKeywords() {
    fetch('/api/keywords/popular?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('popular-keywords');
                container.innerHTML = '';
                
                if (data.data.length === 0) {
                    container.innerHTML = '<p class="text-center">æš‚æ— æ•°æ®</p>';
                    return;
                }
                
                data.data.forEach(keyword => {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-secondary mr-1 mb-1';
                    badge.textContent = `${keyword.keyword} (${keyword.count})`;
                    container.appendChild(badge);
                });
            }
        })
        .catch(error => {
            console.error('åŠ è½½çƒ­é—¨å…³é”®è¯å¤±è´¥:', error);
            document.getElementById('popular-keywords').innerHTML = 
                '<p class="text-center text-danger">åŠ è½½å¤±è´¥</p>';
        });
}

function createCategoryChart(data) {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(data),
            datasets: [{
                data: Object.values(data),
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF',
                    '#4BC0C0', '#FF6384', '#36A2EB', '#FFCE56'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                position: 'bottom'
            }
        }
    });
}

function createSourceChart(data) {
    const ctx = document.getElementById('sourceChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(data),
            datasets: [{
                label: 'è®ºæ–‡æ•°é‡',
                data: Object.values(data),
                backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function showPaperDetail(paperId) {
    // æ˜¾ç¤ºè®ºæ–‡è¯¦æƒ…ï¼ˆå¯ä»¥å®ç°ä¸ºæ¨¡æ€æ¡†ï¼‰
    alert('è®ºæ–‡è¯¦æƒ…åŠŸèƒ½å¾…å®ç°ï¼Œè®ºæ–‡ID: ' + paperId);
}
</script>
{% endblock %}