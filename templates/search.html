{% extends "base.html" %}

{% block title %}æœç´¢æ–‡çŒ® - MedLitAgent{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">ğŸ” æœç´¢æ–‡çŒ®</h1>
        </div>
    </div>

    <!-- æœç´¢è¡¨å• -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">æœç´¢æ¡ä»¶</h5>
                </div>
                <div class="card-body">
                    <form id="search-form">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label for="search-query">å…³é”®è¯æœç´¢</label>
                                    <input type="text" class="form-control" id="search-query" 
                                           placeholder="è¾“å…¥æœç´¢å…³é”®è¯...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label for="search-category">åŒ»å­¦åˆ†ç±»</label>
                                    <select class="form-control" id="search-category">
                                        <option value="">æ‰€æœ‰åˆ†ç±»</option>
                                        <option value="cardiology">å¿ƒè„ç—…å­¦</option>
                                        <option value="oncology">è‚¿ç˜¤å­¦</option>
                                        <option value="neurology">ç¥ç»å­¦</option>
                                        <option value="immunology">å…ç–«å­¦</option>
                                        <option value="pharmacology">è¯ç†å­¦</option>
                                        <option value="genetics">é—ä¼ å­¦</option>
                                        <option value="infectious_diseases">ä¼ æŸ“ç—…å­¦</option>
                                        <option value="surgery">å¤–ç§‘å­¦</option>
                                        <option value="pediatrics">å„¿ç§‘å­¦</option>
                                        <option value="psychiatry">ç²¾ç¥ç—…å­¦</option>
                                        <option value="radiology">æ”¾å°„å­¦</option>
                                        <option value="pathology">ç—…ç†å­¦</option>
                                        <option value="epidemiology">æµè¡Œç—…å­¦</option>
                                        <option value="public_health">å…¬å…±å«ç”Ÿ</option>
                                        <option value="clinical_trials">ä¸´åºŠè¯•éªŒ</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="search-source">æ•°æ®æº</label>
                                    <select class="form-control" id="search-source">
                                        <option value="">æ‰€æœ‰æ¥æº</option>
                                        <option value="pubmed">PubMed</option>
                                        <option value="arxiv">arXiv</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="search-limit">ç»“æœæ•°é‡</label>
                                    <select class="form-control" id="search-limit">
                                        <option value="20">20</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-1">
                                <div class="form-group">
                                    <label>&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-block">
                                        <i class="fas fa-search"></i> æœç´¢
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- æœç´¢ç»“æœ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">æœç´¢ç»“æœ</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportResults('csv')">
                            <i class="fas fa-download"></i> å¯¼å‡ºCSV
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="exportResults('excel')">
                            <i class="fas fa-file-excel"></i> å¯¼å‡ºExcel
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="exportResults('json')">
                            <i class="fas fa-code"></i> å¯¼å‡ºJSON
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- åŠ è½½çŠ¶æ€ -->
                    <div id="loading-indicator" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">æœç´¢ä¸­...</span>
                        </div>
                        <p class="mt-2">æ­£åœ¨æœç´¢æ–‡çŒ®...</p>
                    </div>

                    <!-- æœç´¢ç»“æœç»Ÿè®¡ -->
                    <div id="search-stats" class="mb-3" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            æ‰¾åˆ° <strong id="result-count">0</strong> ç¯‡ç›¸å…³æ–‡çŒ®
                            <span id="search-time"></span>
                        </div>
                    </div>

                    <!-- ç»“æœåˆ—è¡¨ -->
                    <div id="search-results">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p>è¯·è¾“å…¥æœç´¢æ¡ä»¶å¼€å§‹æœç´¢æ–‡çŒ®</p>
                        </div>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <nav id="pagination" style="display: none;">
                        <ul class="pagination justify-content-center">
                            <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è®ºæ–‡è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="paperModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">è®ºæ–‡è¯¦æƒ…</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="paper-detail-content">
                    <!-- è®ºæ–‡è¯¦æƒ…å†…å®¹ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
                <button type="button" class="btn btn-primary" onclick="openPaperUrl()">æŸ¥çœ‹åŸæ–‡</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentSearchParams = {};
let currentPage = 1;
let totalPages = 1;

document.addEventListener('DOMContentLoaded', function() {
    // ç»‘å®šæœç´¢è¡¨å•æäº¤äº‹ä»¶
    document.getElementById('search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });
    
    // åŠ è½½åˆ†ç±»é€‰é¡¹
    loadCategories();
});

function loadCategories() {
    fetch('/api/categories')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('search-category');
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"æ‰€æœ‰åˆ†ç±»"ï¼‰
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // æ·»åŠ åˆ†ç±»é€‰é¡¹
                data.data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.name;
                    option.textContent = category.display_name || category.name;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
        });
}

function performSearch(page = 1) {
    const query = document.getElementById('search-query').value.trim();
    const category = document.getElementById('search-category').value;
    const source = document.getElementById('search-source').value;
    const limit = parseInt(document.getElementById('search-limit').value);
    
    // æ„å»ºæœç´¢å‚æ•°
    const params = new URLSearchParams();
    if (query) params.append('query', query);
    if (category) params.append('category', category);
    if (source) params.append('source', source);
    params.append('page', page);
    params.append('per_page', limit);
    
    currentSearchParams = {query, category, source, limit};
    currentPage = page;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading(true);
    hideResults();
    
    const startTime = Date.now();
    
    fetch(`/api/papers?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            const endTime = Date.now();
            const searchTime = ((endTime - startTime) / 1000).toFixed(2);
            
            showLoading(false);
            
            if (data.success) {
                displayResults(data.data, searchTime);
            } else {
                showError(data.error || 'æœç´¢å¤±è´¥');
            }
        })
        .catch(error => {
            showLoading(false);
            showError('ç½‘ç»œé”™è¯¯: ' + error.message);
            console.error('æœç´¢å¤±è´¥:', error);
        });
}

function showLoading(show) {
    document.getElementById('loading-indicator').style.display = show ? 'block' : 'none';
}

function hideResults() {
    document.getElementById('search-stats').style.display = 'none';
    document.getElementById('pagination').style.display = 'none';
}

function displayResults(data, searchTime) {
    const resultsContainer = document.getElementById('search-results');
    const statsContainer = document.getElementById('search-stats');
    const paginationContainer = document.getElementById('pagination');
    
    // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
    document.getElementById('result-count').textContent = data.total || 0;
    document.getElementById('search-time').textContent = `(ç”¨æ—¶ ${searchTime} ç§’)`;
    statsContainer.style.display = 'block';
    
    // æ˜¾ç¤ºç»“æœ
    if (!data.papers || data.papers.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡çŒ®</p>
                <p class="small">è¯·å°è¯•è°ƒæ•´æœç´¢æ¡ä»¶</p>
            </div>
        `;
        return;
    }
    
    // ç”Ÿæˆç»“æœHTML
    let html = '';
    data.papers.forEach(paper => {
        html += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-9">
                            <h5 class="card-title">
                                <a href="#" onclick="showPaperDetail(${paper.id})" class="text-decoration-none">
                                    ${paper.title || 'æ— æ ‡é¢˜'}
                                </a>
                            </h5>
                            <p class="card-text">
                                <strong>ä½œè€…:</strong> ${paper.authors || 'N/A'}<br>
                                <strong>æœŸåˆŠ:</strong> ${paper.journal || 'N/A'}<br>
                                <strong>å‘è¡¨æ—¥æœŸ:</strong> ${paper.publication_date || 'N/A'}
                            </p>
                            ${paper.abstract ? `<p class="card-text"><small class="text-muted">${paper.abstract.substring(0, 200)}...</small></p>` : ''}
                        </div>
                        <div class="col-md-3">
                            <div class="text-right">
                                ${paper.predicted_category ? `<span class="badge badge-primary mb-2">${paper.predicted_category}</span><br>` : ''}
                                <span class="badge badge-secondary">${paper.source || 'N/A'}</span><br>
                                ${paper.doi ? `<small><a href="https://doi.org/${paper.doi}" target="_blank" class="text-muted">DOI: ${paper.doi}</a></small><br>` : ''}
                                ${paper.url ? `<small><a href="${paper.url}" target="_blank" class="text-muted">æŸ¥çœ‹åŸæ–‡</a></small>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsContainer.innerHTML = html;
    
    // æ˜¾ç¤ºåˆ†é¡µ
    if (data.total > data.per_page) {
        totalPages = Math.ceil(data.total / data.per_page);
        displayPagination();
        paginationContainer.style.display = 'block';
    }
}

function displayPagination() {
    const paginationContainer = document.querySelector('#pagination .pagination');
    let html = '';
    
    // ä¸Šä¸€é¡µ
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="performSearch(${currentPage - 1})">ä¸Šä¸€é¡µ</a>
        </li>
    `;
    
    // é¡µç 
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += '<li class="page-item"><a class="page-link" href="#" onclick="performSearch(1)">1</a></li>';
        if (startPage > 2) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="performSearch(${i})">${i}</a>
            </li>
        `;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="performSearch(${totalPages})">${totalPages}</a></li>`;
    }
    
    // ä¸‹ä¸€é¡µ
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="performSearch(${currentPage + 1})">ä¸‹ä¸€é¡µ</a>
        </li>
    `;
    
    paginationContainer.innerHTML = html;
}

function showError(message) {
    const resultsContainer = document.getElementById('search-results');
    resultsContainer.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            ${message}
        </div>
    `;
}

function showPaperDetail(paperId) {
    fetch(`/api/papers/${paperId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPaperDetail(data.data);
                $('#paperModal').modal('show');
            } else {
                alert('åŠ è½½è®ºæ–‡è¯¦æƒ…å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        })
        .catch(error => {
            alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            console.error('åŠ è½½è®ºæ–‡è¯¦æƒ…å¤±è´¥:', error);
        });
}

function displayPaperDetail(paper) {
    const content = document.getElementById('paper-detail-content');
    content.innerHTML = `
        <div class="row">
            <div class="col-12">
                <h4>${paper.title || 'æ— æ ‡é¢˜'}</h4>
                <hr>
                <p><strong>ä½œè€…:</strong> ${paper.authors || 'N/A'}</p>
                <p><strong>æœŸåˆŠ:</strong> ${paper.journal || 'N/A'}</p>
                <p><strong>å‘è¡¨æ—¥æœŸ:</strong> ${paper.publication_date || 'N/A'}</p>
                <p><strong>æ•°æ®æº:</strong> <span class="badge badge-secondary">${paper.source || 'N/A'}</span></p>
                ${paper.predicted_category ? `<p><strong>åˆ†ç±»:</strong> <span class="badge badge-primary">${paper.predicted_category}</span></p>` : ''}
                ${paper.doi ? `<p><strong>DOI:</strong> <a href="https://doi.org/${paper.doi}" target="_blank">${paper.doi}</a></p>` : ''}
                ${paper.url ? `<p><strong>åŸæ–‡é“¾æ¥:</strong> <a href="${paper.url}" target="_blank">æŸ¥çœ‹åŸæ–‡</a></p>` : ''}
                ${paper.abstract ? `<div><strong>æ‘˜è¦:</strong><p class="mt-2">${paper.abstract}</p></div>` : ''}
            </div>
        </div>
    `;
    
    // ä¿å­˜å½“å‰è®ºæ–‡URLç”¨äº"æŸ¥çœ‹åŸæ–‡"æŒ‰é’®
    window.currentPaperUrl = paper.url;
}

function openPaperUrl() {
    if (window.currentPaperUrl) {
        window.open(window.currentPaperUrl, '_blank');
    } else {
        alert('æ— å¯ç”¨çš„åŸæ–‡é“¾æ¥');
    }
}

function exportResults(format) {
    if (!currentSearchParams.query && !currentSearchParams.category && !currentSearchParams.source) {
        alert('è¯·å…ˆè¿›è¡Œæœç´¢');
        return;
    }
    
    const params = new URLSearchParams();
    if (currentSearchParams.query) params.append('query', currentSearchParams.query);
    if (currentSearchParams.category) params.append('category', currentSearchParams.category);
    if (currentSearchParams.source) params.append('source', currentSearchParams.source);
    params.append('format', format);
    params.append('limit', 1000); // å¯¼å‡ºæ›´å¤šç»“æœ
    
    const url = `/api/export?${params.toString()}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}